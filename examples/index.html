
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://mydomain.org/mysite/examples/">
      
      
        <link rel="prev" href="../language-manual/">
      
      
        <link rel="next" href="../data-and-codata/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Examples - Coal</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#examples" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Coal" class="md-header__button md-logo" aria-label="Coal" data-md-component="logo">
      
  <img src="../assets/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Coal
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Examples
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Coal" class="md-nav__button md-logo" aria-label="Coal" data-md-component="logo">
      
  <img src="../assets/logo.svg" alt="logo">

    </a>
    Coal
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting started
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../language-manual/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Language manual
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Examples
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Examples
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#quicksort" class="md-nav__link">
    <span class="md-ellipsis">
      
        Quicksort
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#basic-io" class="md-nav__link">
    <span class="md-ellipsis">
      
        Basic I/O
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Basic I/O">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#do-notation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Do-notation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monads" class="md-nav__link">
    <span class="md-ellipsis">
      
        Monads
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Monads">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reader" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reader
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#writer" class="md-nav__link">
    <span class="md-ellipsis">
      
        Writer
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state" class="md-nav__link">
    <span class="md-ellipsis">
      
        State
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-structures" class="md-nav__link">
    <span class="md-ellipsis">
      
        Data structures
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Data structures">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#avl-tree-map" class="md-nav__link">
    <span class="md-ellipsis">
      
        AVL-Tree Map
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../data-and-codata/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data and codata
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../license/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    License
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#quicksort" class="md-nav__link">
    <span class="md-ellipsis">
      
        Quicksort
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#basic-io" class="md-nav__link">
    <span class="md-ellipsis">
      
        Basic I/O
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Basic I/O">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#do-notation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Do-notation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monads" class="md-nav__link">
    <span class="md-ellipsis">
      
        Monads
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Monads">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reader" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reader
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#writer" class="md-nav__link">
    <span class="md-ellipsis">
      
        Writer
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state" class="md-nav__link">
    <span class="md-ellipsis">
      
        State
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-structures" class="md-nav__link">
    <span class="md-ellipsis">
      
        Data structures
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Data structures">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#avl-tree-map" class="md-nav__link">
    <span class="md-ellipsis">
      
        AVL-Tree Map
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="examples">Examples</h1>
<h2 id="quicksort">Quicksort</h2>
<h4 id="treecoal">Tree.coal</h4>
<div class="highlight"><pre><span></span><code>module Tree {

  type Tree&lt;a&gt;
    = Node(a, Tree&lt;a&gt;, Tree&lt;a&gt;)
    | Leaf

  fun flatten(tree) = 
    fold(tree) {
      | Node(y, @lhs, @rhs) =&gt;
          lhs ++ y :: rhs
      | Leaf =&gt;
          []
    }

}
</code></pre></div>
<h4 id="qsortcoal">Qsort.coal</h4>
<div class="highlight"><pre><span></span><code>module Qsort(sort) {

  import Tree(type Tree, flatten)
  import Coal.Combinators(always)
  import Number(_INT32_MAX)

  fun binary_search_tree(list : List&lt;int32&gt;) : Tree&lt;int32&gt; =
    fold(list, { min = 0, max = _INT32_MAX }) {
      | (p :: @g) =&gt;
          fn(range) =&gt;
            if (p &gt; range.min &amp;&amp; p &lt;= range.max)
              then 
                Node
                  ( p 
                  , g({ min = range.min, max = p })
                  , g({ min = p, max = range.max })
                  )
              else
                g(range)
      | [] =&gt;
          always(Leaf)
    }

  let sort = flatten &lt;&lt; binary_search_tree

}
</code></pre></div>
<h4 id="maincoal">Main.coal</h4>
<div class="highlight"><pre><span></span><code>module Main {

  import Qsort(sort)
  import Coal.Monad(trait Monad, and_eval)
  import IO(return)

  import namespace IO

  fun print_all(ints : List&lt;int32&gt;) : IO&lt;unit&gt; =
    fold(ints) {
      | [] =&gt; 
          return()
      | m :: @next =&gt;
          IO.println_int32(m) |. and_eval(next)
    }

  fun main() = 
    let xs = [105, 103, 234, 109, 107, 55, 102, 999, 101, 8, 106, 104]
    in
    print_all(sort(xs))

}
</code></pre></div>
<h2 id="basic-io">Basic I/O</h2>
<p>This program demonstrates how to combine parsing and monadic pipelining to build a small interactive console application.
Using <code>IO</code> operations composed through monadic combinators, the program asks the user for their name and then runs a simple number-guessing game</p>
<div class="highlight"><pre><span></span><code>module Main {

  import Char(digit_to_int32)
  import Coal.Functor(trait Functor(map))
  import Coal.Monad(trait Monad, and_then)
  import IO(readln, println_string, random, return)
  import List(is_empty)
  import Number(double_to_int32)
  import String(to_list, remove_whitespace, int32_to_string)

  fun digits_to_unsigned(chars) : Option&lt;int32&gt; =
    if (is_empty(chars)) 
      then
        None
      else
        fold(chars, Some(0)) {
          | ch :: @go =&gt;
              fn(t) =&gt;
                match(digit_to_int32(ch)) {
                  | Some(n) =&gt;
                      go(map(fn(s) =&gt; n + 10 * s, t))
                  | None =&gt;
                      None
                }
          | [] =&gt;
              fn(t) =&gt; t
        }

  fun parse_int32(str : string) : Option&lt;int32&gt; =
    digits_to_unsigned(to_list(remove_whitespace(str)))

  fun random_int32() : IO&lt;int32&gt; =
    random()
      |. and_then(fn(n) =&gt; return(double_to_int32(n * 10)))

  fun main() = 
    println_string(&quot;Enter your name&quot;)
      |. and_then(readln)
      |. and_then(fn(s) =&gt; println_string(&quot;Hello, &quot; &lt;&gt; s &lt;&gt; &quot;!&quot;))
      |. and_then(random_int32)
      |. and_then(fn(rand) =&gt; 
           println_string(&quot;Guess what number I am thinking of&quot;)
             |. and_then(readln)
             |. and_then(fn(s) =&gt; 
                  match(parse_int32(s)) {
                    | Some(n) =&gt;
                        if (n == rand) 
                          then println_string(&quot;You guessed right!&quot;)
                          else println_string(&quot;Sorry, the number I was thinking of was &quot; &lt;&gt; int32_to_string(rand) &lt;&gt; &quot;.&quot;)
                    | None =&gt;
                        println_string(&quot;Not a number&quot;)
                  }
                )
         )

}
</code></pre></div>
<h3 id="do-notation">Do-notation</h3>
<p>Using <code>do</code>-notation, we can refactor <code>main</code> in the above program, so that it
instead becomes:</p>
<div class="highlight"><pre><span></span><code>  fun main() = do {
    println_string(&quot;Enter your name&quot;);
    name &lt;- readln();
    println_string(&quot;Hello, &quot; &lt;&gt; name &lt;&gt; &quot;!&quot;);

    rand &lt;- random_int32();
    println_string(&quot;Guess what number I am thinking of&quot;);
    guess &lt;- readln();

    println_string(
      match(parse_int32(guess)) {
        | Some(n) =&gt;
            if (n == rand) 
              then &quot;You guessed right!&quot;
              else &quot;Sorry, the number I was thinking of was &quot; &lt;&gt; int32_to_string(rand) &lt;&gt; &quot;.&quot;
        | None =&gt;
            &quot;Not a number&quot;
      });
  }
</code></pre></div>
<!--
## JSON

TODO
-->

<h2 id="monads">Monads</h2>
<p>These examples reimplement Haskellâ€™s Reader, Writer, and State monads.</p>
<h3 id="reader">Reader</h3>
<div class="highlight"><pre><span></span><code>module Main {

  import namespace IO
  import Coal.Monad(trait Monad, and_then)
  import Coal.Functor(trait Functor)
  import Coal.Applicative(trait Applicative)

  type Reader&lt;r, a&gt; = Reader(r -&gt; a)

  fun run_reader(reader, env) =
    match(reader) {
      | Reader(f) =&gt; f(env)
    }

  fun ask() = 
    Reader(fn(env) =&gt; env)

  instance Functor&lt;Reader&lt;r&gt;&gt; {
    fun map(f, Reader(g)) =
      Reader(fn(r) =&gt; f(g(r)))
  }

  instance Applicative&lt;Reader&lt;r&gt;&gt; {
    fun pure(r) = 
      Reader(fn(_) =&gt; r)

    fun ap(Reader(f), Reader(g)) =
      Reader(fn(r) =&gt;
        let func = f(r) in
        let a    = g(r) in
        func(a)
      )
  }

  instance Monad&lt;Reader&lt;r&gt;&gt; {
    fun bind(reader : Reader&lt;r, a&gt;, next : a -&gt; Reader&lt;r, b&gt;) : Reader&lt;r, b&gt; = 
      match(reader) {
        | Reader(f) =&gt;
            Reader(fn(env) =&gt;
              let a = 
                f(env) 
              in
              match(next(a)) {
                | Reader(g) =&gt; g(env)
              }
            )
      }
  }

  fun local(transform, Reader(f)) = 
    Reader(fn(env) =&gt; f(transform(env)))

  // Example use:

  fun test_reader(val : int32) : Reader&lt;int32, int32&gt; =
    ask()
      |. and_then(fn(r) =&gt; pure(val + r))

  fun main() =
    IO.println_int32(run_reader(test_reader(5), 5))

}
</code></pre></div>
<h3 id="writer">Writer</h3>
<div class="highlight"><pre><span></span><code>module Main {

  import namespace IO
  import namespace List
  import Coal.Monad(trait Monad, and_then, and_eval)
  import Coal.Functor(trait Functor)
  import Coal.Applicative(trait Applicative)
  import Coal.Monoid(trait Monoid)
  import IO(return)

  type Writer&lt;w, a&gt; = Writer(a, w)

  fun run_writer(writer) =
    match(writer) {
      | Writer(a, w) =&gt; (a, w)
    }

  instance Functor&lt;Writer&lt;w&gt;&gt; {
    fun map(f, Writer(a, w)) =
      Writer(f(a), w)
  }

  instance Applicative&lt;Writer&lt;w&gt;&gt; {
    fun pure(w) = 
      Writer(w, id)

    fun ap(Writer(f, w1), Writer(a, w2)) =
      Writer(f(a), w1 &lt;&gt; w2)
  }

  instance Monad&lt;Writer&lt;w&gt;&gt; {
    fun bind(writer, k) : Writer&lt;w, b&gt; =
      match(writer) {
        | Writer(a, w1) =&gt;
            match(k(a)) {
              | Writer(b, w2) =&gt; 
                  Writer(b, w1 &lt;&gt; w2)
            }
      }
  }

  fun tell(w) : Writer&lt;w, unit&gt; =
    Writer((), w)

  fun listen(m) : Writer&lt;w,(a, w)&gt; =
    match(m) {
      | Writer(a, w) =&gt; Writer((a, w), w)
    }

  // Example use:

  fun test_writer() : Writer&lt;List&lt;string&gt;, int32&gt; =
    tell([&quot;one&quot;])
      |. and_eval(tell([&quot;two&quot;]))
      |. and_eval(tell([&quot;three&quot;]))
      |. and_eval(pure(100))

  fun print_msgs(msgs : List&lt;string&gt;) =
    fold(msgs) {
      | [] =&gt; 
          return()
      | m :: @next =&gt;
          IO.println_string(m) |. and_eval(next)
    }

  fun main() =
    match(run_writer(test_writer())) {
      | ((_, w)) =&gt; print_msgs(w)
    }

}
</code></pre></div>
<h3 id="state">State</h3>
<div class="highlight"><pre><span></span><code>module Main {

  import namespace IO
  import Coal.Functor(trait Functor)
  import Coal.Monad(trait Monad, and_then)
  import Coal.Applicative(trait Applicative)
  import Coal.Combinators(fst)

  type State&lt;s, a&gt; = State(s -&gt; (a, s))

  fun run_state(State(f), s) = 
    f(s)

  fun eval_state(st, s0) =
    fst(run_state(st, s0))

  instance Functor&lt;State&lt;s&gt;&gt; {
    fun map(f, State(g)) =
      State(fn(s) =&gt;
        let (a, s1) = g(s) 
        in
        (f(a), s1)
      )
  }

  instance Applicative&lt;State&lt;s&gt;&gt; {
    fun pure(x) =
      State(fn(s) =&gt; (x, s))

    fun ap(State(sf), State(sa)) =
      State(fn(s0) =&gt;
        let (f, s1) = sf(s0) in
        let (a, s2) = sa(s1) in
        (f(a), s2)
      )
  }

  instance Monad&lt;State&lt;s&gt;&gt; {
    fun bind(m, k) =
      State(fn(s0) =&gt;
        let (a, s1) = run_state(m, s0) 
        in
        run_state(k(a), s1)
      )
  }

  fun get() = 
    State(fn(s) =&gt; (s, s))

  fun put(s) = 
    State(fn(_) =&gt; ((), s))

  fun modify(f) = 
    State(fn(s) =&gt; ((), f(s)))

  // Example use:

  fun authenticate
    | &quot;password123&quot; = put(true)
    | _             = put(false)

   fun msg(success : bool) =
     if (success) then &quot;Logged in&quot; else &quot;Authentication failed&quot;

  fun state_example(pw : string) =
    get()
      |. and_then(fn(logged_in) =&gt; 
           if (logged_in) 
             then pure(&quot;Already logged in&quot;)
             else 
               authenticate(pw) 
                 |. and_then(get) 
                 |. and_then(pure &lt;&lt; msg)
      )

  fun main() =
    IO.println_string(eval_state(state_example(&quot;abc123&quot;), false))

}
</code></pre></div>
<h2 id="data-structures">Data structures</h2>
<h3 id="avl-tree-map">AVL-Tree Map</h3>
<div class="highlight"><pre><span></span><code>module Map {

  import Number(max)

  type alias MapFields&lt;key, val&gt; =
    { key    : key
    , value  : val
    , height : int32
    , left   : Map&lt;key, val&gt;
    , right  : Map&lt;key, val&gt; 
    }

  type Map&lt;key, val&gt; = Empty | Map(MapFields&lt;key, val&gt;)

  // Helpers

  fun height(map) =
    match(map) {
      | Empty =&gt; 0
      | Map({ height = h | _ }) =&gt; h
    }

  fun make_node(key, val, left, right) =
    Map({ key    = key
        , value  = val
        , height = 1 + max(height(left), height(right))
        , left   = left
        , right  = right
        })

  fun balance_factor
    | Empty  = 0
    | Map(m) = height(m.left) - height(m.right)

  // Constructors

  let empty = Empty

  fun singleton(key, val) = 
    make_node(key, val, Empty, Empty)

  // Rotations

  //
  //       y              x
  //      / \            / \
  //     x   t3   ==&gt;   t1  y
  //    / \                / \
  //   t1 t2              t2 t3
  //

  fun rotate_right(map) = 
    match(map) {
      | Map({ key = yk, value = yv, left = Map(x), right = t3 | _ }) =&gt; 
          let t1 = x.left;
              t2 = x.right
          in
          make_node(x.key, x.value, t1, make_node(yk, yv, t2, t3))
      | _ =&gt; 
          map
    }

  //
  //     x                 y
  //    / \               / \
  //   t1  y     ==&gt;     x  t3
  //      / \           / \
  //     t2 t3         t1 t2
  //

  fun rotate_left(map) = 
    match(map) {
      | Map({ key = xk, value = xv, left = t1, right = Map(y) | _ }) =&gt; 
          let t2 = y.left;
              t3 = y.right
          in
          make_node(y.key, y.value, make_node(xk, xv, t1, t2), t3)
      | _ =&gt; 
          map
    }

  // Rebalancing

  fun rebalance(map) =
    match(map) {
      | Empty =&gt;
          Empty

      | Map(m) =&gt;
          let bf = balance_factor(map) in
          if (bf &gt; 1) then
            if (balance_factor(m.left) &lt; 0) then
              rotate_right(
                make_node(m.key, m.value,
                  rotate_left(m.left),
                  m.right
                )
              )
            else
              rotate_right(map)

          else if (bf &lt; -1) then
            if (balance_factor(m.right) &gt; 0) then
              rotate_left(
                make_node(m.key, m.value,
                  m.left,
                  rotate_right(m.right)
                )
              )
            else
              rotate_left(map)

          else
            map
    }

  // Lookup

  fun lookup(key, map) =
    fold(map) {
      | Empty =&gt;
          None

      | Map({ key = key_, value = value, left = @left, right = @right | _ }) =&gt;
          if (key == key_) then
            Some(value)
          else 
            if (key &lt; key_) then
              left
            else
              right
    }

  // Insertion

  fun insert(key, val, map) =
    fold(map) {
      | Empty =&gt;
          singleton(key, val)

      | Map({ left = @left, right = @right | _ } as m) =&gt;
          if (key == m.key) then
            make_node(key, val, m.left, m.right)

          else if (key &lt; m.key) then
            rebalance(make_node(m.key, m.value, left, m.right))

          else
            rebalance(make_node(m.key, m.value, m.left, right))
    }

  // Deletion

  fold delete_min_node : Map&lt;k, v&gt; -&gt; (Option&lt;k&gt;, Option&lt;v&gt;, Map&lt;k, v&gt;) {
    | Empty =&gt;
        (None, None, Empty)

    | Map({ left = Empty | _ } as m) =&gt;
        (Some(m.key), Some(m.value), m.right)

    | Map({ left = delete_min_node(@left) | _ } as m) =&gt;
        let (k, v, new_left) = left 
        in
        (Some(k), Some(v), rebalance(make_node(m.key, m.value, new_left, m.right)))
  }

  fun delete(key, map) =
    fold(map) {
      | Empty =&gt;
          Empty

      | Map({ left = @left, right = @right as rhs | _ } as m) =&gt;
          if (key &lt; m.key) then
            rebalance(make_node(m.key, m.value, left, m.right))

          else if (key &gt; m.key) then
            rebalance(make_node(m.key, m.value, m.left, right))

          else
            match(delete_min_node(m.right)) {
              | (Some(k), Some(v), new_right) =&gt;
                  rebalance(make_node(k, v, m.left, new_right))
              | _ =&gt;
                  m.left
            }
    }
}
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": [], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>